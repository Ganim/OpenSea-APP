/**
 * OpenSea OS - Employees Page
 * Pagina de gerenciamento de funcionarios usando o novo sistema OpenSea OS
 */

'use client';

import { GridError } from '@/components/handlers/grid-error';
import { GridLoading } from '@/components/handlers/grid-loading';
import { Header } from '@/components/layout/header';
import { PageActionBar } from '@/components/layout/page-action-bar';
import {
  PageBody,
  PageHeader,
  PageLayout,
} from '@/components/layout/page-layout';
import { SearchBar } from '@/components/layout/search-bar';
import type { HeaderButton } from '@/components/layout/types/header.types';
import { FilterDropdown } from '@/components/ui/filter-dropdown';
import {
  CoreProvider,
  EntityCard,
  EntityContextMenu,
  EntityGrid,
  SelectionToolbar,
  useEntityCrud,
  useEntityPage,
  type SortDirection,
} from '@/core';
import type { Employee } from '@/types/hr';
import {
  ArrowLeft,
  Briefcase,
  Building2,
  ExternalLink,
  Factory,
  Plus,
  Upload,
  Users,
} from 'lucide-react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Suspense, useCallback, useMemo } from 'react';
import { toast } from 'sonner';
import {
  createEmployee,
  CreateModal,
  DeleteConfirmModal,
  deleteEmployee,
  DuplicateConfirmModal,
  duplicateEmployee,
  EditModal,
  employeesApi,
  employeesConfig,
  updateEmployee,
  ViewModal,
  type CreateEmployeeWithUserRequest,
} from './src';
import { useListCompanies } from '../companies/src';
import { useListDepartments } from '../departments/src';
import { useListPositions } from '../positions/src';

export default function EmployeesPage() {
  return (
    <Suspense
      fallback={<GridLoading count={9} layout="grid" size="md" gap="gap-4" />}
    >
      <EmployeesPageContent />
    </Suspense>
  );
}

function EmployeesPageContent() {
  const router = useRouter();
  const searchParams = useSearchParams();

  // ============================================================================
  // URL-BASED FILTERS
  // ============================================================================

  const companyIds = useMemo(() => {
    const raw = searchParams.get('company');
    return raw ? raw.split(',').filter(Boolean) : [];
  }, [searchParams]);

  const departmentIds = useMemo(() => {
    const raw = searchParams.get('department');
    return raw ? raw.split(',').filter(Boolean) : [];
  }, [searchParams]);

  const positionIds = useMemo(() => {
    const raw = searchParams.get('position');
    return raw ? raw.split(',').filter(Boolean) : [];
  }, [searchParams]);

  // ============================================================================
  // FETCH REFERENCE DATA FOR FILTERS AND ENRICHMENT
  // ============================================================================

  const { data: companiesData } = useListCompanies({ perPage: 100 });
  const { data: departmentsData } = useListDepartments({ perPage: 100 });
  const { data: positionsData } = useListPositions({ perPage: 100 });

  // Build lookup maps for enriching employees and displaying badges
  const companyMap = useMemo(() => {
    const map = new Map<
      string,
      { id: string; tradeName: string | null; legalName: string }
    >();
    if (companiesData?.companies) {
      for (const c of companiesData.companies) {
        map.set(c.id, {
          id: c.id,
          tradeName: c.tradeName ?? null,
          legalName: c.legalName,
        });
      }
    }
    return map;
  }, [companiesData?.companies]);

  const departmentMap = useMemo(() => {
    const map = new Map<
      string,
      { id: string; name: string; companyId: string | null }
    >();
    if (departmentsData?.departments) {
      for (const d of departmentsData.departments) {
        map.set(d.id, {
          id: d.id,
          name: d.name,
          companyId: d.companyId ?? null,
        });
      }
    }
    return map;
  }, [departmentsData?.departments]);

  const positionMap = useMemo(() => {
    const map = new Map<
      string,
      { id: string; name: string; departmentId: string | null }
    >();
    if (positionsData?.positions) {
      for (const p of positionsData.positions) {
        map.set(p.id, {
          id: p.id,
          name: p.name,
          departmentId: p.departmentId ?? null,
        });
      }
    }
    return map;
  }, [positionsData?.positions]);

  // ============================================================================
  // CRUD SETUP (always fetches ALL employees - filtering is client-side)
  // ============================================================================

  const crud = useEntityCrud<Employee>({
    entityName: 'Employee',
    entityNamePlural: 'Employees',
    queryKey: ['employees'],
    baseUrl: '/api/v1/hr/employees',
    listFn: async () => {
      const empResponse = await employeesApi.list({ includeDeleted: false });

      // Normalize employees
      const maybeEmployees = empResponse as {
        employees?: Employee[];
        data?: Employee[];
      };
      const items = (
        Array.isArray(empResponse)
          ? empResponse
          : (maybeEmployees.employees ?? maybeEmployees.data ?? [])
      ) as Employee[];

      return items.filter(employee => !employee.deletedAt);
    },
    getFn: (id: string) => employeesApi.get(id),
    createFn: createEmployee,
    updateFn: updateEmployee,
    deleteFn: deleteEmployee,
    duplicateFn: duplicateEmployee,
  });

  // ============================================================================
  // PAGE SETUP
  // ============================================================================

  const page = useEntityPage<Employee>({
    entityName: 'Employee',
    entityNamePlural: 'Employees',
    queryKey: ['employees'],
    crud,
    viewRoute: id => `/hr/employees/${id}`,
    filterFn: (item, query) => {
      const q = query.toLowerCase();
      const fullName = item.fullName?.toLowerCase() || '';
      const registration = item.registrationNumber?.toLowerCase() || '';
      const cpf = item.cpf || '';

      return [fullName, registration, cpf].some(value => value.includes(q));
    },
    duplicateConfig: {
      getNewName: item => `${item.fullName} (copia)`,
      getData: item => ({
        fullName: `${item.fullName} (copia)`,
        registrationNumber: `${item.registrationNumber}_COPY`,
        cpf: item.cpf,
        hireDate: new Date().toISOString(),
        baseSalary: item.baseSalary,
        contractType: item.contractType,
        workRegime: item.workRegime,
        weeklyHours: item.weeklyHours,
        departmentId: item.departmentId,
        positionId: item.positionId,
      }),
    },
  });

  // ============================================================================
  // CLIENT-SIDE URL FILTERS
  // ============================================================================

  const displayedEmployees = useMemo(() => {
    let items = page.filteredItems || [];
    if (companyIds.length > 0) {
      const set = new Set(companyIds);
      items = items.filter(e => {
        // Check direct companyId or department's company
        if (e.companyId && set.has(e.companyId)) return true;
        const dept = e.departmentId ? departmentMap.get(e.departmentId) : null;
        return dept?.companyId && set.has(dept.companyId);
      });
    }
    if (departmentIds.length > 0) {
      const set = new Set(departmentIds);
      items = items.filter(e => e.departmentId && set.has(e.departmentId));
    }
    if (positionIds.length > 0) {
      const set = new Set(positionIds);
      items = items.filter(e => e.positionId && set.has(e.positionId));
    }
    return items;
  }, [
    page.filteredItems,
    companyIds,
    departmentIds,
    positionIds,
    departmentMap,
  ]);

  // Derive filter options from hook data
  const availableCompanies = useMemo(() => {
    if (!companiesData?.companies) return [];
    return companiesData.companies.map(c => ({
      id: c.id,
      name: c.tradeName || c.legalName,
    }));
  }, [companiesData?.companies]);

  const availableDepartments = useMemo(() => {
    if (!departmentsData?.departments) return [];

    // If no company filter, show all departments
    if (companyIds.length === 0) {
      return departmentsData.departments.map(d => ({
        id: d.id,
        name: d.name,
      }));
    }

    // Narrow: only departments belonging to selected companies
    const cmpSet = new Set(companyIds);
    return departmentsData.departments
      .filter(d => d.companyId && cmpSet.has(d.companyId))
      .map(d => ({
        id: d.id,
        name: d.name,
      }));
  }, [departmentsData?.departments, companyIds]);

  const availablePositions = useMemo(() => {
    if (!positionsData?.positions) return [];

    // If no department filter, show all positions
    if (departmentIds.length === 0) {
      return positionsData.positions.map(p => ({
        id: p.id,
        name: p.name,
      }));
    }

    // Narrow: only positions belonging to selected departments
    const deptSet = new Set(departmentIds);
    return positionsData.positions
      .filter(p => p.departmentId && deptSet.has(p.departmentId))
      .map(p => ({
        id: p.id,
        name: p.name,
      }));
  }, [positionsData?.positions, departmentIds]);

  // Build URL preserving all filter params
  const buildFilterUrl = useCallback(
    (params: {
      company?: string[];
      department?: string[];
      position?: string[];
    }) => {
      const cmp = params.company !== undefined ? params.company : companyIds;
      const dept =
        params.department !== undefined ? params.department : departmentIds;
      const pos = params.position !== undefined ? params.position : positionIds;
      const parts: string[] = [];
      if (cmp.length > 0) parts.push(`company=${cmp.join(',')}`);
      if (dept.length > 0) parts.push(`department=${dept.join(',')}`);
      if (pos.length > 0) parts.push(`position=${pos.join(',')}`);
      return parts.length > 0
        ? `/hr/employees?${parts.join('&')}`
        : '/hr/employees';
    },
    [companyIds, departmentIds, positionIds]
  );

  const setCompanyFilter = useCallback(
    (ids: string[]) => {
      router.push(buildFilterUrl({ company: ids }));
    },
    [router, buildFilterUrl]
  );

  const setDepartmentFilter = useCallback(
    (ids: string[]) => {
      router.push(buildFilterUrl({ department: ids }));
    },
    [router, buildFilterUrl]
  );

  const setPositionFilter = useCallback(
    (ids: string[]) => {
      router.push(buildFilterUrl({ position: ids }));
    },
    [router, buildFilterUrl]
  );

  // ============================================================================
  // HANDLERS
  // ============================================================================

  const handleContextView = (ids: string[]) => {
    page.handlers.handleItemsView(ids);
  };

  const handleContextEdit = (ids: string[]) => {
    page.handlers.handleItemsEdit(ids);
  };

  const handleContextDuplicate = (ids: string[]) => {
    page.handlers.handleItemsDuplicate(ids);
  };

  const handleContextDelete = (ids: string[]) => {
    page.modals.setItemsToDelete(ids);
    page.modals.open('delete');
  };

  const customSortByRegistration = (
    a: Employee,
    b: Employee,
    direction: SortDirection
  ) => {
    const regA = a.registrationNumber?.toLowerCase() ?? '';
    const regB = b.registrationNumber?.toLowerCase() ?? '';
    const sortResult = regA.localeCompare(regB, 'pt-BR');
    return direction === 'asc' ? sortResult : -sortResult;
  };

  // ============================================================================
  // RENDER FUNCTIONS
  // ============================================================================

  const renderGridCard = (item: Employee, isSelected: boolean) => {
    // Get info from lookup maps
    const posInfo = item.positionId ? positionMap.get(item.positionId) : null;
    const deptInfo = item.departmentId
      ? departmentMap.get(item.departmentId)
      : null;
    const companyInfo = item.companyId
      ? companyMap.get(item.companyId)
      : deptInfo?.companyId
        ? companyMap.get(deptInfo.companyId)
        : null;
    const companyName = companyInfo?.tradeName || companyInfo?.legalName;

    return (
      <EntityContextMenu
        itemId={item.id}
        onView={handleContextView}
        onEdit={handleContextEdit}
        onDuplicate={handleContextDuplicate}
        onDelete={handleContextDelete}
      >
        <EntityCard
          id={item.id}
          variant="grid"
          title={item.fullName}
          subtitle={posInfo?.name || 'Sem cargo definido'}
          icon={Users}
          iconBgColor="bg-gradient-to-br from-emerald-500 to-teal-600"
          badges={[
            ...(posInfo
              ? [
                  {
                    label: posInfo.name,
                    variant: 'outline' as const,
                    icon: Briefcase,
                  },
                ]
              : []),
            ...(deptInfo
              ? [
                  {
                    label: deptInfo.name,
                    variant: 'outline' as const,
                    icon: Building2,
                  },
                ]
              : []),
            ...(companyName
              ? [
                  {
                    label: companyName,
                    variant: 'outline' as const,
                    icon: Factory,
                  },
                ]
              : []),
          ]}
          isSelected={isSelected}
          showSelection={false}
          clickable={false}
          createdAt={item.createdAt}
          updatedAt={item.updatedAt}
          showStatusBadges={true}
        />
      </EntityContextMenu>
    );
  };

  const renderListCard = (item: Employee, isSelected: boolean) => {
    // Get info from lookup maps
    const posInfo = item.positionId ? positionMap.get(item.positionId) : null;
    const deptInfo = item.departmentId
      ? departmentMap.get(item.departmentId)
      : null;
    const companyInfo = item.companyId
      ? companyMap.get(item.companyId)
      : deptInfo?.companyId
        ? companyMap.get(deptInfo.companyId)
        : null;
    const companyName = companyInfo?.tradeName || companyInfo?.legalName;

    return (
      <EntityContextMenu
        itemId={item.id}
        onView={handleContextView}
        onEdit={handleContextEdit}
        onDuplicate={handleContextDuplicate}
        onDelete={handleContextDelete}
      >
        <EntityCard
          id={item.id}
          variant="list"
          title={item.fullName}
          subtitle={posInfo?.name || 'Sem cargo definido'}
          icon={Users}
          iconBgColor="bg-gradient-to-br from-emerald-500 to-teal-600"
          badges={[
            ...(posInfo
              ? [
                  {
                    label: posInfo.name,
                    variant: 'outline' as const,
                    icon: Briefcase,
                  },
                ]
              : []),
            ...(deptInfo
              ? [
                  {
                    label: deptInfo.name,
                    variant: 'outline' as const,
                    icon: Building2,
                  },
                ]
              : []),
            ...(companyName
              ? [
                  {
                    label: companyName,
                    variant: 'outline' as const,
                    icon: Factory,
                  },
                ]
              : []),
          ]}
          isSelected={isSelected}
          showSelection={false}
          clickable={false}
          createdAt={item.createdAt}
          updatedAt={item.updatedAt}
          showStatusBadges={true}
        />
      </EntityContextMenu>
    );
  };

  // ============================================================================
  // COMPUTED VALUES
  // ============================================================================

  const selectedIds = Array.from(page.selection?.state.selectedIds || []);
  const hasSelection = selectedIds.length > 0;

  const initialIds = useMemo(
    () => displayedEmployees.map(i => i.id),
    [displayedEmployees]
  );

  // ============================================================================
  // HEADER BUTTONS CONFIGURATION
  // ============================================================================

  const handleImport = useCallback(() => {
    router.push('/import/hr/employees');
  }, [router]);

  const handleCreate = useCallback(() => {
    page.modals.open('create');
  }, [page.modals]);

  const actionButtons: HeaderButton[] = useMemo(
    () => [
      {
        id: 'import-employees',
        title: 'Importar',
        icon: Upload,
        onClick: handleImport,
        variant: 'outline',
      },
      {
        id: 'create-employee',
        title: 'Novo Funcionario',
        icon: Plus,
        onClick: handleCreate,
        variant: 'default',
      },
    ],
    [handleImport, handleCreate]
  );

  // ============================================================================
  // RENDER
  // ============================================================================

  return (
    <CoreProvider
      selection={{
        namespace: 'employees',
        initialIds,
      }}
    >
      <PageLayout>
        <PageHeader>
          <PageActionBar
            buttons={actionButtons}
            onBack={() => router.back()}
            backLabel="RH"
            backIcon={ArrowLeft}
          />

          <Header
            title="Funcionarios"
            description="Gerencie os funcionarios da organizacao"
          />
        </PageHeader>

        <PageBody>
          {/* Search Bar */}
          <SearchBar
            placeholder={employeesConfig.display.labels.searchPlaceholder}
            value={page.searchQuery}
            onSearch={value => page.setSearchQuery(value)}
            showClear={true}
            size="md"
          />

          {/* Filters */}
          <div className="flex items-center gap-3 flex-wrap">
            <FilterDropdown
              label="Empresa"
              icon={Building2}
              options={availableCompanies.map(c => ({
                id: c.id,
                label: c.name,
              }))}
              selected={companyIds}
              onSelectionChange={setCompanyFilter}
              activeColor="emerald"
              searchPlaceholder="Buscar empresa..."
              emptyText="Nenhuma empresa encontrada."
              footerAction={{
                icon: ExternalLink,
                label: 'Ver todas as empresas',
                onClick: () => router.push('/hr/companies'),
                color: 'emerald',
              }}
            />
            <FilterDropdown
              label="Departamento"
              icon={Building2}
              options={availableDepartments.map(d => ({
                id: d.id,
                label: d.name,
              }))}
              selected={departmentIds}
              onSelectionChange={setDepartmentFilter}
              activeColor="blue"
              searchPlaceholder="Buscar departamento..."
              emptyText="Nenhum departamento encontrado."
              footerAction={{
                icon: ExternalLink,
                label: 'Ver todos os departamentos',
                onClick: () => router.push('/hr/departments'),
                color: 'blue',
              }}
            />
            <FilterDropdown
              label="Cargo"
              icon={Briefcase}
              options={availablePositions.map(p => ({
                id: p.id,
                label: p.name,
              }))}
              selected={positionIds}
              onSelectionChange={setPositionFilter}
              activeColor="violet"
              searchPlaceholder="Buscar cargo..."
              emptyText="Nenhum cargo encontrado."
              footerAction={{
                icon: ExternalLink,
                label: 'Ver todos os cargos',
                onClick: () => router.push('/hr/positions'),
                color: 'violet',
              }}
            />
          </div>

          {/* Grid */}
          {page.isLoading ? (
            <GridLoading count={9} layout="grid" size="md" gap="gap-4" />
          ) : page.error ? (
            <GridError
              type="server"
              title="Erro ao carregar funcionarios"
              message="Ocorreu um erro ao tentar carregar os funcionarios. Por favor, tente novamente."
              action={{
                label: 'Tentar Novamente',
                onClick: () => crud.refetch(),
              }}
            />
          ) : (
            <EntityGrid
              config={employeesConfig}
              items={displayedEmployees}
              renderGridItem={renderGridCard}
              renderListItem={renderListCard}
              isLoading={page.isLoading}
              isSearching={!!page.searchQuery}
              onItemClick={(item, e) => page.handlers.handleItemClick(item, e)}
              onItemDoubleClick={item =>
                page.handlers.handleItemDoubleClick(item)
              }
              showSorting={true}
              customSortFn={customSortByRegistration}
              customSortLabel="Matricula"
            />
          )}

          {/* Selection Toolbar */}
          {hasSelection && (
            <SelectionToolbar
              selectedIds={selectedIds}
              totalItems={displayedEmployees.length}
              onClear={() => page.selection?.actions.clear()}
              onSelectAll={() => page.selection?.actions.selectAll()}
              defaultActions={{
                view: true,
                edit: true,
                duplicate: true,
                delete: true,
              }}
              handlers={{
                onView: page.handlers.handleItemsView,
                onEdit: page.handlers.handleItemsEdit,
                onDuplicate: page.handlers.handleItemsDuplicate,
                onDelete: page.handlers.handleItemsDelete,
              }}
            />
          )}

          {/* View Modal */}
          <ViewModal
            isOpen={page.modals.isOpen('view')}
            onClose={() => page.modals.close('view')}
            employee={page.modals.viewingItem}
          />

          {/* Create Modal */}
          <CreateModal
            isOpen={page.modals.isOpen('create')}
            onClose={() => page.modals.close('create')}
            isSubmitting={crud.isCreating}
            onSubmit={async data => {
              try {
                // Extrair dados especificos do usuario
                const {
                  createUser,
                  permissionGroupId,
                  userEmail,
                  userPassword,
                  ...employeeData
                } = data;

                if (
                  createUser &&
                  permissionGroupId &&
                  userEmail &&
                  userPassword
                ) {
                  // Usar a nova rota que cria funcionario + usuario automaticamente
                  await employeesApi.createWithUser({
                    ...(employeeData as CreateEmployeeWithUserRequest),
                    permissionGroupId,
                    userEmail,
                    userPassword,
                  });
                  await crud.refetch();
                  toast.success('Funcionario e usuario criados com sucesso!', {
                    description:
                      'O usuario foi criado automaticamente com as permissoes selecionadas.',
                    duration: 5000,
                  });
                } else {
                  // Criar apenas o funcionario
                  await crud.create(employeeData);
                  toast.success('Funcionario criado com sucesso!');
                }
              } catch (error) {
                console.error('Erro ao criar funcionario:', error);
                toast.error('Erro ao criar funcionario');
              }
            }}
          />

          {/* Edit Modal */}
          <EditModal
            isOpen={page.modals.isOpen('edit')}
            onClose={() => page.modals.close('edit')}
            employee={page.modals.editingItem}
            isSubmitting={crud.isUpdating}
            onSubmit={async (id, data) => {
              await crud.update(id, data);
            }}
          />

          {/* Delete Confirmation */}
          <DeleteConfirmModal
            isOpen={page.modals.isOpen('delete')}
            onClose={() => page.modals.close('delete')}
            itemCount={page.modals.itemsToDelete.length}
            onConfirm={page.handlers.handleDeleteConfirm}
            isLoading={crud.isDeleting}
          />

          {/* Duplicate Confirmation */}
          <DuplicateConfirmModal
            isOpen={page.modals.isOpen('duplicate')}
            onClose={() => page.modals.close('duplicate')}
            itemCount={page.modals.itemsToDuplicate.length}
            onConfirm={page.handlers.handleDuplicateConfirm}
            isLoading={crud.isDuplicating}
          />
        </PageBody>
      </PageLayout>
    </CoreProvider>
  );
}
